#!/bin/sh
############# build_gsoap-2.7.10

. $EXTERNALS_CONFIG

cd $PACKAGE_SRC_NAME && echo Changed directory to `pwd`

# This version of gSOAP does something funny. It will add -DWITH_DOM
# when compiling its libraries but never compile dom.cpp so any
# program that links with the libraries will have undefined
# symbols. This was never a problem in the past because we never used
# the libraries, we compiled stdospa2.cpp ourselves and did not pass
# -DWITH_DOM. However, we are going to start using this external
# properly now and need to fix this bug. -matt 140907
#patch -p1 < ../with_dom_removal.patch
#if [ $? -ne 0 ]
#then
#	echo "Removal of -DWITH_DOM failed!"
#	exit 1
#fi

patch -p1 < ../install_soapcpp2_wsdl2h_aux-2.7.10-Makefile.in.patch
if [ $? -ne 0 ]
then
   echo "Patching to install aux files failed!"
   exit 1
fi

# This should patch Makefile.am, but the proper automake version is
# not available on all NMI build machines
patch -p1 < ../nmi_prereq_hack.patch
if [ $? -ne 0 ]
then
   echo "Patching to gsoap/wsdl/Makefile.in failed!"
   exit 1
fi

# 1st: This should ideally patch configure.in, but the proper autoconf
# version is not available on all NMI build machines.
# 2nd: This should be a patch instead of a cp, but the patch was too
# big and cuased the patch program on hpux to:
#  Ran out of memory using Plan A -- trying again...
#  patching file configure .../build_gsoap-2.7.10-p1[40]: 16038 Bus error(coredump)
#cp ../configure-2.6.10-no-locale-patched configure
#patch -p1 < ../no_locale_hack.patch
#if [ $? -ne 0 ]
#then
#   echo "Rewriting configure failed!"
#   exit 1
#fi

# For some reason stdsoap2.h tries to include xlocale.h even when it
# does not HAVE_XLOCALE_H
patch -p1 < ../fix_xlocale_insanity.patch
if [ $? -ne 0 ]
then
   echo "Patching not include xlocale.h when not available"
   exit 1
fi

#patch -p1 < ../2.7.10-upd.patch
#if [ $? -ne 0 ]
#then
#   echo "Patching to bug fix upd version failed!"
#   exit 1
#fi
#
#patch -p1 < ../no_locale.patch
#if [ $? -ne 0 ]
#then
#   echo "Patching to avoid locale issues failed!"
#   exit 1
#fi

./configure --prefix=$PACKAGE_INSTALL_DIR \
            --disable-dependency-tracking \
            --with-ccopts=$PACKAGE_DEBUG \
            CPPFLAGS=-I$EXT_INSTALL/$EXT_OPENSSL_VERSION/include/

make
if [ $? -ne 0 ]
then
	echo "make failed!"
	exit 1
fi

make install
if [ $? -ne 0 ]
then
	echo "make install failed!"
	exit 3
fi

exit 0;

############# end of build_gsoap-2.7.10
